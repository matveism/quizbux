<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Work Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#fdf2f8',
                            100: '#fce7f3',
                            200: '#fbcfe8',
                            300: '#f9a8d4',
                            400: '#f472b6',
                            500: '#ec4899',
                            600: '#db2777',
                            700: '#be185d',
                            800: '#9d174d',
                            900: '#831843',
                        },
                        dark: {
                            50: '#f8fafc',
                            100: '#f1f5f9',
                            200: '#e2e8f0',
                            300: '#cbd5e1',
                            400: '#94a3b8',
                            500: '#64748b',
                            600: '#475569',
                            700: '#334155',
                            800: '#1e293b',
                            900: '#0f172a',
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', sans-serif;
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .card-gradient {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0.05) 100%);
            backdrop-filter: blur(10px);
        }
        
        .progress-fill {
            transition: width 0.5s ease-in-out;
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .status-badge {
            transition: all 0.3s ease;
        }
        
        .status-badge:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .modal-overlay {
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
        }
        
        .submission-item {
            border-left: 3px solid;
            transition: all 0.3s ease;
        }
        
        .submission-item:hover {
            transform: translateX(2px);
        }
    </style>
</head>
<body class="gradient-bg min-h-screen flex items-center justify-center p-4 font-sans">
    <div class="w-full max-w-md">
        <!-- Header -->
        <div class="bg-white/10 backdrop-blur-md rounded-t-xl p-4 border-b border-white/20">
            <div class="flex justify-between items-center">
                <div>
                    <img src="https://i.postimg.cc/FK5qWX8z/Gemini-Generated-Image-3osxq23osxq23osx-removebg-preview.png" 
                         width="180" height="70" alt="QuizBux Logo" class="mx-auto">
                </div>
                <div class="flex space-x-2">
                    <div class="w-6 h-6 bg-white/20 rounded"></div>
                    <div class="w-6 h-6 bg-white/20 rounded"></div>
                    <div class="w-6 h-6 bg-white/20 rounded"></div>
                </div>
            </div>
        </div>

        <!-- Main Container -->
        <div class="bg-dark-800 rounded-b-xl shadow-xl overflow-hidden">
            <!-- Login Form (Initially Visible) -->
            <div id="loginForm" class="p-6">
                <div class="mb-5">
                    <label class="block text-white text-sm font-medium mb-2" for="username">Username</label>
                    <input type="text" id="username" 
                           class="w-full px-4 py-3 bg-dark-700 border border-dark-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-primary-500"
                           placeholder="Enter your username">
                </div>
                <div class="mb-6">
                    <label class="block text-white text-sm font-medium mb-2" for="password">Password</label>
                    <input type="password" id="password" 
                           class="w-full px-4 py-3 bg-dark-700 border border-dark-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-primary-500"
                           placeholder="Enter your password">
                </div>
                <button onclick="login()" 
                        class="w-full bg-gradient-to-r from-primary-500 to-primary-600 hover:from-primary-600 hover:to-primary-700 text-white font-medium py-3 px-4 rounded-lg transition duration-300 transform hover:-translate-y-1">
                    Login
                </button>
            </div>

            <!-- Dashboard (Initially Hidden) -->
            <div id="dashboard" class="hidden">
                <!-- User Info -->
                <div class="p-4 flex items-center border-b border-dark-700">
                    <div class="w-12 h-12 bg-primary-500 rounded-full flex items-center justify-center text-white font-bold text-lg mr-4">
                        <span id="userAvatar">U</span>
                    </div>
                    <div class="flex-1">
                        <div class="text-white font-medium" id="displayUsername">Username</div>
                        <button onclick="logout()" class="text-primary-400 text-sm hover:text-primary-300 transition-colors">Logout</button>
                    </div>
                </div>

                <!-- Stats Grid -->
                <div class="p-4 grid grid-cols-2 gap-3">
                    <div class="card-gradient rounded-xl p-4 border border-white/10">
                        <div class="text-white font-bold text-xl" id="balanceValue">0.00</div>
                        <div class="text-primary-300 text-sm">WorkRate</div>
                    </div>
                    <div class="card-gradient rounded-xl p-4 border border-white/10">
                        <div class="text-white font-bold text-xl" id="usdBalanceValue">$0.00</div>
                        <div class="text-primary-300 text-sm">PTS</div>
                    </div>
                    <div class="card-gradient rounded-xl p-4 border border-white/10">
                        <div class="text-white font-bold text-xl" id="workRateValue">0</div>
                        <div class="text-primary-300 text-sm">USD</div>
                    </div>
                    <div class="card-gradient rounded-xl p-4 border border-white/10">
                        <div class="text-white font-bold text-xl" id="levelValue">0</div>
                        <div class="text-primary-300 text-sm">WorkLevel</div>
                    </div>
                </div>

                <!-- Level Progress -->
                <div class="px-4 pb-4">
                    <div class="flex justify-between mb-2">
                        <div class="text-white text-sm font-medium">Performance Level</div>
                        <div class="text-white text-sm font-medium" id="levelPercent">0%</div>
                    </div>
                    <div class="h-2 bg-dark-700 rounded-full overflow-hidden">
                        <div id="levelProgress" class="h-full bg-gradient-to-r from-primary-500 to-primary-600 progress-fill" style="width: 0%"></div>
                    </div>
                </div>

                <!-- Bottom Navigation -->
                <div class="flex border-t border-dark-700">
                    <div class="nav-item flex-1 text-center py-3 text-white font-medium cursor-pointer transition-colors border-b-2 border-primary-500" 
                         data-target="work-section">Work</div>
                    <div class="nav-item flex-1 text-center py-3 text-dark-400 font-medium cursor-pointer transition-colors hover:text-white" 
                         data-target="cashout-section">Cashout</div>
                    <div class="nav-item flex-1 text-center py-3 text-dark-400 font-medium cursor-pointer transition-colors hover:text-white" 
                         data-target="terms-section">Terms</div>
                </div>

                <!-- Content Sections -->
                <div class="p-4">
                    <!-- Work Section -->
                    <div class="content-section active fade-in" id="work-section">
                        <!-- Work Submission Form -->
                        <div class="card-gradient rounded-xl p-4 mb-4 border border-white/10">
                            <div class="text-white font-medium mb-3">Submit Work</div>
                            <textarea id="workInput" 
                                      class="w-full px-4 py-3 bg-dark-700 border border-dark-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-primary-500 mb-3 resize-none"
                                      rows="4" placeholder="Enter your work submission here..."></textarea>
                            <button onclick="submitWork()" 
                                    class="w-full bg-gradient-to-r from-primary-500 to-primary-600 hover:from-primary-600 hover:to-primary-700 text-white font-medium py-3 px-4 rounded-lg transition duration-300">
                                Submit Work
                            </button>
                        </div>

                        <!-- Submission Status -->
                        <div>
                            <div class="text-white font-medium mb-3">Submission Status</div>
                            <div class="space-y-2 max-h-60 overflow-y-auto" id="statusBadges">
                                <!-- Status badges will be added here dynamically -->
                                <div class="text-center text-white text-sm py-2 rounded bg-dark-700/50">No submissions yet</div>
                            </div>
                        </div>
                    </div>

                    <!-- Cashout Section -->
                    <div class="content-section hidden fade-in" id="cashout-section">
                        <div class="card-gradient rounded-xl p-4 mb-4 border border-white/10">
                            <div class="text-white font-medium mb-3">Request Cashout</div>
                            <select id="rewardSelect" onchange="updateRewardDetails()"
                                    class="w-full px-4 py-3 bg-dark-700 border border-dark-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-primary-500 mb-3">
                                <option value="">Select a reward</option>
                                <option value="amazon_1" data-workrate="1.39" data-amount="1.39">Amazon UK Voucher 1GBP</option>
                                <option value="amazon_2" data-workrate="2.80" data-amount="2.80">Amazon UK Voucher 2GBP</option>
                            </select>
                            
                            <div class="hidden bg-dark-700/50 rounded-lg p-3 mb-3" id="rewardDetails">
                                <div class="flex justify-between text-white text-sm mb-1">
                                    <span>USD Required:</span>
                                    <span id="requiredWorkRate">0</span>
                                </div>
                                <div class="flex justify-between text-white text-sm mb-1">
                                    <span>Amount USD:</span>
                                    <span id="rewardAmount">$0.00</span>
                                </div>
                                <div class="flex justify-between text-white text-sm mb-1">
                                    <span>Your USD Balance:</span>
                                    <span id="userWorkRate">0</span>
                                </div>
                                <div class="flex justify-between text-white text-sm">
                                    <span>Your PTS:</span>
                                    <span id="userBalance">0.00</span>
                                </div>
                            </div>
                            
                            <div class="hidden text-center py-2 rounded-lg text-sm mb-3" id="eligibilityStatus"></div>
                            
                            <button onclick="submitCashout()" id="cashoutBtn" disabled
                                    class="w-full bg-gradient-to-r from-primary-500 to-primary-600 hover:from-primary-600 hover:to-primary-700 text-white font-medium py-3 px-4 rounded-lg transition duration-300 disabled:opacity-50 disabled:cursor-not-allowed">
                                Request Cashout
                            </button>
                        </div>

                        <div>
                            <div class="text-white font-medium mb-3">Cashout History</div>
                            <div id="cashoutHistory" class="space-y-3 max-h-60 overflow-y-auto">
                                <!-- Cashout history will be added here dynamically -->
                                <div class="text-center text-white text-sm py-4 rounded bg-dark-700/50">No cashout requests yet</div>
                            </div>
                        </div>
                    </div>

                    <!-- Terms Section -->
                    <div class="content-section hidden fade-in" id="terms-section">
                        <div class="text-white font-medium mb-4">Terms of Use</div>
                        
                        <div class="space-y-3">
                            <div class="accordion-item bg-dark-700/50 rounded-lg overflow-hidden">
                                <div class="accordion-header p-4 text-white font-medium cursor-pointer flex justify-between items-center">
                                    Work Submission Process
                                    <span class="accordion-icon transform transition-transform">▼</span>
                                </div>
                                <div class="accordion-content max-h-0 overflow-hidden transition-all duration-300">
                                    <div class="p-4 pt-0 text-white/80 text-sm space-y-2">
                                        <p>Users submit their work via the provided form. Our admin team reviews all submitted work for compliance with our guidelines.</p>
                                        <p class="text-primary-300 font-medium">Important: If your work is not approved within 24 hours of submission, this indicates that your submission was incorrect or did not meet our requirements. In such cases, you will not see any approval notification.</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="accordion-item bg-dark-700/50 rounded-lg overflow-hidden">
                                <div class="accordion-header p-4 text-white font-medium cursor-pointer flex justify-between items-center">
                                    Prohibited Activities
                                    <span class="accordion-icon transform transition-transform">▼</span>
                                </div>
                                <div class="accordion-content max-h-0 overflow-hidden transition-all duration-300">
                                    <div class="p-4 pt-0 text-white/80 text-sm space-y-2">
                                        <p>Spamming the submission form is strictly prohibited. This includes but is not limited to:</p>
                                        <ul class="list-disc pl-5 space-y-1">
                                            <li>Submitting duplicate or near-identical work</li>
                                            <li>Submitting low-quality or irrelevant content</li>
                                            <li>Attempting to game the system through automated submissions</li>
                                            <li>Any other activity we determine to be spam</li>
                                        </ul>
                                        <p class="text-primary-300 font-medium">Consequences: If we detect spamming activities, your account will be permanently deleted and you will forfeit your entire balance.</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="accordion-item bg-dark-700/50 rounded-lg overflow-hidden">
                                <div class="accordion-header p-4 text-white font-medium cursor-pointer flex justify-between items-center">
                                    Reward System
                                    <span class="accordion-icon transform transition-transform">▼</span>
                                </div>
                                <div class="accordion-content max-h-0 overflow-hidden transition-all duration-300">
                                    <div class="p-4 pt-0 text-white/80 text-sm space-y-2">
                                        <p>Upon approval of your submitted work, you will receive 50 points, which is approximately equivalent to $0.03 USD.</p>
                                        <p>The conversion rate between points and USD may vary based on current valuation. We reserve the right to adjust the point-to-USD conversion rate at our discretion.</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="accordion-item bg-dark-700/50 rounded-lg overflow-hidden">
                                <div class="accordion-header p-4 text-white font-medium cursor-pointer flex justify-between items-center">
                                    Cashout Policy
                                    <span class="accordion-icon transform transition-transform">▼</span>
                                </div>
                                <div class="accordion-content max-h-0 overflow-hidden transition-all duration-300">
                                    <div class="p-4 pt-0 text-white/80 text-sm space-y-2">
                                        <p>Cashout requests are processed manually by our admin team. Processing times may vary.</p>
                                        <p>Each reward has specific Balance requirements that must be met before you can request that reward.</p>
                                        <p>Cashout requests will initially show as "Unsent" until approved by an admin. Once approved, the status will change to "Approved" and any admin notes will be visible.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Success Modal -->
    <div id="successModal" class="fixed inset-0 z-50 flex items-center justify-center hidden">
        <div class="modal-overlay absolute inset-0"></div>
        <div class="relative bg-dark-800 rounded-xl shadow-xl w-full max-w-sm mx-4 overflow-hidden transform transition-all">
            <div class="bg-gradient-to-r from-primary-500 to-primary-600 p-4">
                <div class="text-white font-medium text-lg">Success</div>
            </div>
            <div class="p-6">
                <p id="successMessage" class="text-white">Your work has been submitted successfully!</p>
            </div>
            <div class="grid grid-cols-1 border-t border-dark-700">
                <button onclick="closeModal('successModal')" class="py-4 text-primary-400 font-medium hover:text-primary-300 transition-colors">OK</button>
            </div>
        </div>
    </div>

    <!-- Error Modal -->
    <div id="errorModal" class="fixed inset-0 z-50 flex items-center justify-center hidden">
        <div class="modal-overlay absolute inset-0"></div>
        <div class="relative bg-dark-800 rounded-xl shadow-xl w-full max-w-sm mx-4 overflow-hidden transform transition-all">
            <div class="bg-gradient-to-r from-red-500 to-red-600 p-4">
                <div class="text-white font-medium text-lg">Error</div>
            </div>
            <div class="p-6">
                <p id="errorMessage" class="text-white">Invalid username or password.</p>
            </div>
            <div class="grid grid-cols-1 border-t border-dark-700">
                <button onclick="closeModal('errorModal')" class="py-4 text-primary-400 font-medium hover:text-primary-300 transition-colors">OK</button>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="fixed inset-0 z-50 flex items-center justify-center hidden">
        <div class="modal-overlay absolute inset-0"></div>
        <div class="relative bg-dark-800 rounded-xl shadow-xl w-full max-w-sm mx-4 overflow-hidden transform transition-all">
            <div class="p-6 flex flex-col items-center">
                <div class="w-12 h-12 border-4 border-primary-500 border-t-transparent rounded-full animate-spin mb-4"></div>
                <p id="loadingMessage" class="text-white">Loading...</p>
            </div>
        </div>
    </div>

    <script>
    // Google Apps Script Web App URL
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwrJuI50NO7QyNr0Pc0HyGKQwHn0Bn8yuTAeIhu_pCf4AlIf_NbWmob4lCyGb8yPaeL/exec';

    // Current user data
    let currentUser = null;
    let userSubmissions = [];
    let userCashouts = [];

    // Session management
    const SESSION_KEY = 'workRewardSession';

    // Check for existing session on page load
    function checkExistingSession() {
        const savedSession = localStorage.getItem(SESSION_KEY);
        if (savedSession) {
            try {
                const sessionData = JSON.parse(savedSession);
                // Check if session is still valid (less than 24 hours old)
                const sessionAge = Date.now() - sessionData.timestamp;
                const twentyFourHours = 24 * 60 * 60 * 1000;
                
                if (sessionAge < twentyFourHours) {
                    // Session is valid, attempt to restore
                    attemptSessionRestore(sessionData.username);
                } else {
                    // Session expired, clear it
                    clearSession();
                }
            } catch (error) {
                console.error('Error parsing saved session:', error);
                clearSession();
            }
        }
    }

    // Attempt to restore user session
    async function attemptSessionRestore(username) {
        try {
            showLoading('Restoring your session...');
            
            const formData = new FormData();
            formData.append('action', 'getUserData');
            formData.append('username', username);
            
            const response = await fetch(SCRIPT_URL, {
                method: 'POST',
                body: formData
            });
            
            const result = await response.json();
            
            if (result.status === 'success') {
                currentUser = result.user;
                userSubmissions = result.submissions || [];
                userCashouts = result.cashouts || [];
                hideLoading();
                showDashboard();
            } else {
                // User data not found or error, clear session
                hideLoading();
                clearSession();
                showError('Session expired. Please login again.');
            }
        } catch (error) {
            console.error('Session restore error:', error);
            hideLoading();
            clearSession();
            showError('Network error during session restore.');
        }
    }

    // Save session to localStorage
    function saveSession(username) {
        const sessionData = {
            username: username,
            timestamp: Date.now()
        };
        localStorage.setItem(SESSION_KEY, JSON.stringify(sessionData));
    }

    // Clear session from localStorage
    function clearSession() {
        localStorage.removeItem(SESSION_KEY);
        currentUser = null;
        userSubmissions = [];
        userCashouts = [];
    }

    // Show loading indicator
    function showLoading(message = 'Loading...') {
        const loadingOverlay = document.getElementById('loadingOverlay');
        const loadingMessage = document.getElementById('loadingMessage');
        
        if (loadingOverlay && loadingMessage) {
            loadingMessage.textContent = message;
            loadingOverlay.classList.remove('hidden');
        }
    }

    // Hide loading indicator
    function hideLoading() {
        const loadingOverlay = document.getElementById('loadingOverlay');
        if (loadingOverlay) {
            loadingOverlay.classList.add('hidden');
        }
    }

    // Login function
    async function login() {
        const username = document.getElementById('username').value;
        const password = document.getElementById('password').value;
        
        if (!username || !password) {
            showError('Please enter both username and password.');
            return;
        }
        
        try {
            showLoading('Signing in...');
            
            const formData = new FormData();
            formData.append('action', 'login');
            formData.append('username', username);
            formData.append('password', password);
            
            const response = await fetch(SCRIPT_URL, {
                method: 'POST',
                body: formData
            });
            
            const result = await response.json();
            
            if (result.status === 'success') {
                currentUser = result.user;
                userSubmissions = result.submissions || [];
                userCashouts = result.cashouts || [];
                
                // Save session
                saveSession(username);
                hideLoading();
                showDashboard();
            } else {
                hideLoading();
                showError(result.message || 'Invalid username or password.');
            }
        } catch (error) {
            console.error('Login error:', error);
            hideLoading();
            showError('Network error. Please try again.');
        }
    }

    // Logout function
    function logout() {
        clearSession();
        
        // Reset forms
        const usernameInput = document.getElementById('username');
        const passwordInput = document.getElementById('password');
        const workInput = document.getElementById('workInput');
        const rewardSelect = document.getElementById('rewardSelect');
        
        if (usernameInput) usernameInput.value = '';
        if (passwordInput) passwordInput.value = '';
        if (workInput) workInput.value = '';
        if (rewardSelect) rewardSelect.value = '';
        
        // Show login form
        const loginForm = document.getElementById('loginForm');
        const dashboard = document.getElementById('dashboard');
        
        if (loginForm) loginForm.classList.remove('hidden');
        if (dashboard) dashboard.classList.add('hidden');
        
        // Hide any modals
        closeAllModals();
    }

    // Show dashboard
    function showDashboard() {
        const loginForm = document.getElementById('loginForm');
        const dashboard = document.getElementById('dashboard');
        
        if (loginForm) loginForm.classList.add('hidden');
        if (dashboard) dashboard.classList.remove('hidden');
        
        if (!currentUser) {
            showError('No user data available.');
            return;
        }
        
        // Update user info
        const userAvatar = document.getElementById('userAvatar');
        const displayUsername = document.getElementById('displayUsername');
        
        if (userAvatar) userAvatar.textContent = currentUser.username.charAt(0).toUpperCase();
        if (displayUsername) displayUsername.textContent = currentUser.username;
        
        // Update stats
        const balanceValue = document.getElementById('balanceValue');
        const usdBalanceValue = document.getElementById('usdBalanceValue');
        const workRateValue = document.getElementById('workRateValue');
        const levelValue = document.getElementById('levelValue');
        
        if (balanceValue) balanceValue.textContent = currentUser.balance || 0;
        if (usdBalanceValue) usdBalanceValue.textContent = `$${parseFloat(currentUser.balanceUSD || 0).toFixed(2)}`;
        if (workRateValue) workRateValue.textContent = currentUser.workRate || 0;
        if (levelValue) levelValue.textContent = currentUser.level || 0;
        
        // Update level progress
        const levelPercent = parseInt(currentUser.level || 0);
        const levelPercentEl = document.getElementById('levelPercent');
        const progressFill = document.getElementById('levelProgress');
        
        if (levelPercentEl) levelPercentEl.textContent = `${levelPercent}%`;
        if (progressFill) {
            progressFill.style.width = `${Math.min(levelPercent, 100)}%`;
        }
        
        // Update submission status badges
        updateStatusBadges();
        
        // Update cashout history
        updateCashoutHistory();
        
        // Reset reward selection
        const rewardSelect = document.getElementById('rewardSelect');
        const rewardDetails = document.getElementById('rewardDetails');
        const eligibilityStatus = document.getElementById('eligibilityStatus');
        const cashoutBtn = document.getElementById('cashoutBtn');
        
        if (rewardSelect) rewardSelect.value = '';
        if (rewardDetails) rewardDetails.classList.add('hidden');
        if (eligibilityStatus) eligibilityStatus.classList.add('hidden');
        if (cashoutBtn) cashoutBtn.disabled = true;
    }

    // Submit work function
    async function submitWork() {
        if (!currentUser) {
            showError('Please login first.');
            return;
        }
        
        const workInput = document.getElementById('workInput');
        const workText = workInput ? workInput.value.trim() : '';
        
        if (!workText) {
            showError('Please enter your work submission.');
            return;
        }
        
        try {
            showLoading('Submitting your work...');
            
            const formData = new FormData();
            formData.append('action', 'submitWork');
            formData.append('username', currentUser.username);
            formData.append('submission', workText);
            
            const response = await fetch(SCRIPT_URL, {
                method: 'POST',
                body: formData
            });
            
            const result = await response.json();
            
            if (result.status === 'success') {
                // Refresh user data to get updated balances
                await refreshUserData();
                
                // Clear input
                if (workInput) workInput.value = '';
                hideLoading();
                
                // Show success message
                showSuccess('Your work has been submitted successfully!');
            } else {
                hideLoading();
                showError(result.message || 'Failed to submit work.');
            }
        } catch (error) {
            console.error('Submit work error:', error);
            hideLoading();
            showError('Network error. Please try again.');
        }
    }

    // Refresh user data from server
    async function refreshUserData() {
        if (!currentUser) return;
        
        try {
            const formData = new FormData();
            formData.append('action', 'getUserData');
            formData.append('username', currentUser.username);
            
            const response = await fetch(SCRIPT_URL, {
                method: 'POST',
                body: formData
            });
            
            const result = await response.json();
            
            if (result.status === 'success') {
                currentUser = result.user;
                userSubmissions = result.submissions || [];
                userCashouts = result.cashouts || [];
                showDashboard(); // Refresh the display
            }
        } catch (error) {
            console.error('Refresh user data error:', error);
        }
    }

    // Update status badges - FIXED TO SHOW ALL SUBMISSIONS
    function updateStatusBadges() {
        const statusBadges = document.getElementById('statusBadges');
        if (!statusBadges) return;
        
        statusBadges.innerHTML = '';
        
        // Show ALL submissions instead of just the first 5
        if (userSubmissions.length === 0) {
            statusBadges.innerHTML = '<div class="text-center text-white text-sm py-2 rounded bg-dark-700/50">No submissions yet</div>';
            return;
        }
        
        userSubmissions.forEach(submission => {
            const badge = document.createElement('div');
            badge.className = `submission-item p-3 mb-2 rounded-lg ${
                submission.status === 'REVIEW' 
                    ? 'bg-yellow-500/20 border-yellow-500' 
                    : 'bg-green-500/20 border-green-500'
            }`;
            
            const statusIcon = submission.status === 'REVIEW' ? '⏳' : '✅';
            const statusText = submission.status === 'REVIEW' ? 'Under Review' : 'Approved';
            
            // Format the date
            const submissionDate = new Date(submission.timestamp);
            const formattedDate = submissionDate.toLocaleDateString() + ' ' + submissionDate.toLocaleTimeString();
            
            badge.innerHTML = `
                <div class="flex justify-between items-start mb-1">
                    <span class="text-white font-medium">${statusIcon} ${statusText}</span>
                    <span class="text-xs text-white/70">${formattedDate}</span>
                </div>
                <div class="text-white/80 text-sm truncate">${submission.submission}</div>
            `;
            
            statusBadges.appendChild(badge);
        });
    }

    // Navigation between sections
    function setupNavigation() {
        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', function() {
                // Remove active class from all nav items and content sections
                document.querySelectorAll('.nav-item').forEach(nav => {
                    nav.classList.remove('border-b-2', 'border-primary-500', 'text-white');
                    nav.classList.add('text-dark-400');
                });
                document.querySelectorAll('.content-section').forEach(section => {
                    section.classList.add('hidden');
                    section.classList.remove('active');
                });
                
                // Add active class to clicked nav item and corresponding section
                this.classList.add('border-b-2', 'border-primary-500', 'text-white');
                this.classList.remove('text-dark-400');
                
                const targetId = this.getAttribute('data-target');
                const targetSection = document.getElementById(targetId);
                if (targetSection) {
                    targetSection.classList.remove('hidden');
                    targetSection.classList.add('active');
                }
            });
        });
    }

    // Update reward details when selection changes
    function updateRewardDetails() {
        if (!currentUser) return;
        
        const select = document.getElementById('rewardSelect');
        const details = document.getElementById('rewardDetails');
        const cashoutBtn = document.getElementById('cashoutBtn');
        const eligibilityStatus = document.getElementById('eligibilityStatus');
        
        if (!select || !details || !cashoutBtn || !eligibilityStatus) return;
        
        if (select.value) {
            const selectedOption = select.options[select.selectedIndex];
            const workRateRequired = selectedOption.getAttribute('data-workrate');
            const amount = selectedOption.getAttribute('data-amount');
            
            const requiredWorkRate = document.getElementById('requiredWorkRate');
            const rewardAmount = document.getElementById('rewardAmount');
            const userWorkRate = document.getElementById('userWorkRate');
            const userBalance = document.getElementById('userBalance');
            
            if (requiredWorkRate) requiredWorkRate.textContent = workRateRequired;
            if (rewardAmount) rewardAmount.textContent = `$${amount}`;
            if (userWorkRate) userWorkRate.textContent = currentUser.workRate || 0;
            if (userBalance) userBalance.textContent = `$${parseFloat(currentUser.balanceUSD || 0).toFixed(2)}`;
            
            details.classList.remove('hidden');
            
            // Check eligibility
            const workRateEligible = parseInt(currentUser.workRate || 0) >= parseInt(workRateRequired);
            const balanceEligible = parseFloat(currentUser.balanceUSD || 0) >= parseFloat(amount);
            const isEligible = workRateEligible && balanceEligible;
            
            // Update eligibility status
            if (isEligible) {
                eligibilityStatus.textContent = "✓ You are eligible for this reward!";
                eligibilityStatus.className = "bg-green-500/20 text-green-300 text-center py-2 rounded-lg text-sm mb-3";
                eligibilityStatus.classList.remove('hidden');
            } else {
                let message = "You are not eligible for this reward. ";
                if (!workRateEligible && !balanceEligible) {
                    message += `You need ${workRateRequired} USD (you have ${currentUser.workRate || 0}) and $${amount} USD balance (you have $${parseFloat(currentUser.balanceUSD || 0).toFixed(2)}).`;
                } else if (!workRateEligible) {
                    message += `You need ${workRateRequired} Work Rate (you have ${currentUser.workRate || 0}).`;
                } else {
                    message += `You need $${amount} USD balance (you have $${parseFloat(currentUser.balanceUSD || 0).toFixed(2)}).`;
                }
                eligibilityStatus.textContent = message;
                eligibilityStatus.className = "bg-red-500/20 text-red-300 text-center py-2 rounded-lg text-sm mb-3";
                eligibilityStatus.classList.remove('hidden');
            }
            
            // Enable/disable cashout button based on requirements
            cashoutBtn.disabled = !isEligible;
        } else {
            details.classList.add('hidden');
            eligibilityStatus.classList.add('hidden');
            cashoutBtn.disabled = true;
        }
    }

    // Submit cashout request
    async function submitCashout() {
        if (!currentUser) {
            showError('Please login first.');
            return;
        }
        
        const select = document.getElementById('rewardSelect');
        if (!select || !select.value) {
            showError('Please select a reward first.');
            return;
        }
        
        const selectedOption = select.options[select.selectedIndex];
        const rewardName = selectedOption.text;
        const workRateRequired = selectedOption.getAttribute('data-workrate');
        const amount = selectedOption.getAttribute('data-amount');
        
        try {
            showLoading('Processing your cashout request...');
            
            const formData = new FormData();
            formData.append('action', 'submitCashout');
            formData.append('username', currentUser.username);
            formData.append('reward', rewardName);
            formData.append('workRateRequired', workRateRequired);
            formData.append('amount', amount);
            
            const response = await fetch(SCRIPT_URL, {
                method: 'POST',
                body: formData
            });
            
            const result = await response.json();
            
            if (result.status === 'success') {
                // Refresh user data to get updated balance
                await refreshUserData();
                
                // Reset form
                if (select) select.value = '';
                const rewardDetails = document.getElementById('rewardDetails');
                const eligibilityStatus = document.getElementById('eligibilityStatus');
                const cashoutBtn = document.getElementById('cashoutBtn');
                
                if (rewardDetails) rewardDetails.classList.add('hidden');
                if (eligibilityStatus) eligibilityStatus.classList.add('hidden');
                if (cashoutBtn) cashoutBtn.disabled = true;
                
                hideLoading();
                showSuccess('Your cashout request has been submitted successfully!');
            } else {
                hideLoading();
                showError(result.message || 'Failed to submit cashout request.');
            }
        } catch (error) {
            console.error('Submit cashout error:', error);
            hideLoading();
            showError('Network error. Please try again.');
        }
    }

    // Update cashout history display - FIXED TO SHOW ALL CASHOUTS
    function updateCashoutHistory() {
        const cashoutHistory = document.getElementById('cashoutHistory');
        if (!cashoutHistory) return;
        
        cashoutHistory.innerHTML = '';
        
        if (userCashouts.length === 0) {
            cashoutHistory.innerHTML = '<div class="text-center text-white text-sm py-4 rounded bg-dark-700/50">No cashout requests yet</div>';
            return;
        }
        
        userCashouts.forEach(cashout => {
            const item = document.createElement('div');
            item.className = 'bg-dark-700/50 rounded-lg p-4';
            
            const header = document.createElement('div');
            header.className = 'flex justify-between items-center mb-2';
            
            const reward = document.createElement('div');
            reward.className = 'text-white font-medium';
            reward.textContent = cashout.reward;
            
            const status = document.createElement('div');
            let statusClass = 'px-2 py-1 rounded-full text-xs font-medium ';
            
            if (cashout.status === 'PENDING' || cashout.status === 'UNSENT') {
                statusClass += 'bg-yellow-500 text-white';
            } else if (cashout.status === 'APPROVED') {
                statusClass += 'bg-green-500 text-white';
            } else {
                statusClass += 'bg-red-500 text-white';
            }
            
            status.className = statusClass;
            status.textContent = cashout.status;
            
            header.appendChild(reward);
            header.appendChild(status);
            
            const details = document.createElement('div');
            details.className = 'grid grid-cols-2 gap-2 text-sm text-white/80 mb-2';
            
            const amount = document.createElement('div');
            amount.textContent = `Amount: $${cashout.amount}`;
            
            const workRate = document.createElement('div');
            workRate.textContent = `Work Rate: ${cashout.workRateRequired}`;
            
            const date = document.createElement('div');
            date.textContent = `Date: ${new Date(cashout.timestamp).toLocaleDateString()}`;
            
            details.appendChild(amount);
            details.appendChild(workRate);
            details.appendChild(date);
            
            item.appendChild(header);
            item.appendChild(details);
            
            // Add notes if available
            if (cashout.notes) {
                const notes = document.createElement('div');
                notes.className = 'text-sm text-white/60 pt-2 border-t border-white/10';
                notes.textContent = `Admin Notes: ${cashout.notes}`;
                item.appendChild(notes);
            }
            
            cashoutHistory.appendChild(item);
        });
    }

    // Toggle accordion for terms section
    function setupAccordion() {
        document.querySelectorAll('.accordion-header').forEach(header => {
            header.addEventListener('click', function() {
                const item = this.parentElement;
                const content = this.nextElementSibling;
                const icon = this.querySelector('.accordion-icon');
                
                if (item.classList.contains('active')) {
                    content.style.maxHeight = '0';
                    icon.style.transform = 'rotate(0deg)';
                    item.classList.remove('active');
                } else {
                    content.style.maxHeight = content.scrollHeight + 'px';
                    icon.style.transform = 'rotate(180deg)';
                    item.classList.add('active');
                }
            });
        });
    }

    // Show success modal
    function showSuccess(message) {
        const successMessage = document.getElementById('successMessage');
        const successModal = document.getElementById('successModal');
        
        if (successMessage) successMessage.textContent = message;
        if (successModal) successModal.classList.remove('hidden');
    }

    // Show error modal
    function showError(message) {
        const errorMessage = document.getElementById('errorMessage');
        const errorModal = document.getElementById('errorModal');
        
        if (errorMessage) errorMessage.textContent = message;
        if (errorModal) errorModal.classList.remove('hidden');
    }

    // Close modal
    function closeModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.classList.add('hidden');
        }
    }

    // Close all modals
    function closeAllModals() {
        const modals = document.querySelectorAll('.modal');
        modals.forEach(modal => {
            modal.classList.add('hidden');
        });
    }

    // Initialize the application
    function initApp() {
        // Set up navigation
        setupNavigation();
        
        // Set up accordion
        setupAccordion();
        
        // Set up enter key for login
        const usernameInput = document.getElementById('username');
        const passwordInput = document.getElementById('password');
        
        function handleEnterKey(e) {
            if (e.key === 'Enter') {
                login();
            }
        }
        
        if (usernameInput) {
            usernameInput.addEventListener('keypress', handleEnterKey);
        }
        if (passwordInput) {
            passwordInput.addEventListener('keypress', handleEnterKey);
        }
        
        // Check for existing session
        checkExistingSession();
    }

    // Initialize when DOM is loaded
    document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
